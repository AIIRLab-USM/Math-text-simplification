from evaluate import load

sari = load('sari')

def evaluate_simplification(source: str, references: list[str], hypothesis: str) -> float:
    """
    Evaluate the simplification using the SARI metric.
    
    Args:
        source (str): The source sentence.
        references (List[str]): The reference sentences (generated by humans in the dataset).
        hypothesis (str): The simplified sentence.
    
    Returns:
        float: The SARI score.
    """
    results = sari.compute(predictions=[hypothesis], references=[references], sources=[source])
    score: float = results['sari'] # type: ignore
    return score

from llm_simplifier import simplify_math_text

def evaluate_simplification_with_llm(source: str, references: list[str]) -> float:
    """
    Evaluate the simplification using the LLM to generate a simplified sentence.
    
    Args:
        source (str): The source sentence.
        references (List[str]): The reference sentences (generated by humans in the dataset).
    
    Returns:
        float: The SARI score of the LLM-generated simplification.
    """
    hypothesis = simplify_math_text(source)
    return evaluate_simplification(source, references, hypothesis)

def main(args=None):
    # Load csv file with Text and Simplified columns
    import pandas as pd
    import argparse
    parser = argparse.ArgumentParser(description="Evaluate the simplification of math text using SARI metric.")
    parser.add_argument('csv_file', type=str, help='Path to the CSV file containing the text and simplified columns.')
    parser.add_argument('--source_col', type=str, default='Text', help='Column name for the source text.')
    parser.add_argument('--simplified_col', type=str, default='Simplified', help='Column name for the simplified text.')
    args = parser.parse_args(args)
    df = pd.read_csv(args.csv_file)
    if args.source_col not in df.columns or args.simplified_col not in df.columns:
        raise ValueError(f"Columns {args.source_col} and {args.simplified_col} must be present in the CSV file.")
    total_score = 0.0
    for index, row in df.iterrows():
        source = row[args.source_col]
        references = row[args.simplified_col].split(';')
        score = evaluate_simplification_with_llm(source, references) # type: ignore
        total_score += score
        print(f"Row {index}: SARI score = {score:.4f}")
    average_score = total_score / len(df)
    print(f"Average SARI score: {average_score:.4f}")
if __name__ == "__main__":
    main()